<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Chatbot with Agent Support</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      color: #333;
      margin: 0;
    }

    .chat-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      padding: 24px;
      width: 100%;
      max-width: 700px;
      min-height: 600px;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    h2 {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 24px;
      color: #1a1a1a;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      margin-top: 8px;
    }

    .status-bot {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .status-waiting {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .status-agent {
      background-color: #e8f5e8;
      color: #388e3c;
    }

    .status-ended {
      background-color: #fce4ec;
      color: #c2185b;
    }

    .chat-messages {
      flex: 1;
      background-color: #f9fafc;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .avatar-user {
      background-color: #0066ff;
      color: white;
    }

    .avatar-bot {
      background-color: #6c757d;
      color: white;
    }

    .avatar-agent {
      background-color: #28a745;
      color: white;
    }

    .avatar-system {
      background-color: #ffc107;
      color: #212529;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
      position: relative;
    }

    .message.user .message-content {
      background-color: #0066ff;
      color: white;
    }

    .message-content.bot {
      background-color: white;
      border: 1px solid #e0e0e0;
      color: #333;
    }

    .message-content.agent {
      background-color: #e8f5e8;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
    }

    .message-content.system {
      background-color: #fff8e1;
      border: 1px solid #ffecb3;
      color: #f57c00;
      font-style: italic;
    }

    .message-sender {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .message-time {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 4px;
    }

    .input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }

    .action-btn {
      padding: 8px 16px;
      border: 1px solid #0066ff;
      background-color: transparent;
      color: #0066ff;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background-color: #0066ff;
      color: white;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      border-color: #0066ff;
    }

    button {
      padding: 12px 20px;
      background-color: #0066ff;
      border: none;
      color: white;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #0050cc;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .typing-indicator {
      display: none;
      padding: 10px;
      font-style: italic;
      color: #666;
      font-size: 14px;
    }

    .queue-info {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 14px;
      color: #856404;
    }

    .agent-info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 14px;
      color: #0c5460;
    }

    .connection-status {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #28a745;
    }

    .connection-status.disconnected {
      background-color: #dc3545;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="connection-status" id="connectionStatus"></div>
    
    <div class="chat-header">
      <h2>üí¨ Enhanced Customer Support</h2>
      <div class="status-indicator" id="statusIndicator">
        <span id="statusIcon">ü§ñ</span>
        <span id="statusText">AI Assistant</span>
      </div>
    </div>

    <div id="queueInfo" class="queue-info" style="display: none;">
      <strong>‚è≥ You are in queue</strong><br>
      <span id="queuePosition">Position: 1</span> ‚Ä¢ Estimated wait: <span id="estimatedWait">2-3 minutes</span>
    </div>

    <div id="agentInfo" class="agent-info" style="display: none;">
      <strong>üë®‚Äçüíº Connected to Agent</strong><br>
      <span id="agentName">Agent Name</span> is now assisting you
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message">
        <div class="message-avatar avatar-bot">ü§ñ</div>
        <div class="message-content bot">
          <div class="message-sender">AI Assistant</div>
          <div>üí° Hello! I'm here to help you. I can answer questions using our knowledge base, or if you need more personalized assistance, I can connect you with a human agent.</div>
          <div class="message-time">Just now</div>
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      ‚è≥ <span id="typingText">AI is thinking...</span>
    </div>

    <div class="input-section">
      <div class="action-buttons">
        <button class="action-btn" id="talkToAgentBtn" onclick="requestAgent()">üë®‚Äçüíº Talk to Agent</button>
        <button class="action-btn" id="endChatBtn" onclick="endChat()" style="display: none;">‚ùå End Chat</button>
        <button class="action-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
      </div>
      
      <div class="input-row">
        <input type="text" id="userQuery" placeholder="Type your message here..." maxlength="1000" />
        <button onclick="sendQuery()" id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    let sessionId = null;
    let chatStatus = 'bot';
    let pollInterval = null;
    let lastMessageCount = 0;

    // Initialize chat
    document.addEventListener('DOMContentLoaded', function() {
      // Enable Enter key to send message
      document.getElementById('userQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendQuery();
        }
      });

      // Start polling for updates when waiting for agent or with agent
      startPolling();
    });

    function updateConnectionStatus(connected = true) {
      const status = document.getElementById('connectionStatus');
      if (connected) {
        status.classList.remove('disconnected');
      } else {
        status.classList.add('disconnected');
      }
    }

    function updateChatStatus(status, data = {}) {
      const previousStatus = chatStatus;
      chatStatus = status;
      const statusIndicator = document.getElementById('statusIndicator');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const queueInfo = document.getElementById('queueInfo');
      const agentInfo = document.getElementById('agentInfo');
      const talkToAgentBtn = document.getElementById('talkToAgentBtn');
      const endChatBtn = document.getElementById('endChatBtn');

      // Reset all status displays
      queueInfo.style.display = 'none';
      agentInfo.style.display = 'none';
      statusIndicator.className = 'status-indicator';
      
      // Start or stop polling based on status change
      if ((status === 'waiting_agent' || status === 'with_agent') && 
          (previousStatus !== 'waiting_agent' && previousStatus !== 'with_agent')) {
        startPolling();
      } else if (status === 'bot' || status === 'ended') {
        stopPolling();
      }

      switch (status) {
        case 'bot':
          statusIndicator.classList.add('status-bot');
          statusIcon.textContent = 'ü§ñ';
          statusText.textContent = 'AI Assistant';
          talkToAgentBtn.style.display = 'inline-block';
          endChatBtn.style.display = 'none';
          break;

        case 'waiting_agent':
          statusIndicator.classList.add('status-waiting');
          statusIcon.textContent = '‚è≥';
          statusText.textContent = 'Waiting for Agent';
          queueInfo.style.display = 'block';
          if (data.queue_position) {
            document.getElementById('queuePosition').textContent = `Position: ${data.queue_position}`;
            document.getElementById('estimatedWait').textContent = `${data.queue_position * 2}-${data.queue_position * 3} minutes`;
          }
          talkToAgentBtn.style.display = 'none';
          endChatBtn.style.display = 'inline-block';
          break;

        case 'with_agent':
          statusIndicator.classList.add('status-agent');
          statusIcon.textContent = 'üë®‚Äçüíº';
          statusText.textContent = 'With Agent';
          agentInfo.style.display = 'block';
          if (data.agent_name) {
            document.getElementById('agentName').textContent = data.agent_name;
          }
          talkToAgentBtn.style.display = 'none';
          endChatBtn.style.display = 'inline-block';
          break;

        case 'ended':
          statusIndicator.classList.add('status-ended');
          statusIcon.textContent = '‚úÖ';
          statusText.textContent = 'Chat Ended';
          talkToAgentBtn.style.display = 'inline-block';
          endChatBtn.style.display = 'none';
          break;
      }
    }

    async function sendQuery() {
      const input = document.getElementById('userQuery');
      const sendBtn = document.getElementById('sendBtn');
      const query = input.value.trim();
      
      if (!query) return;

      // Disable input while sending
      sendBtn.disabled = true;
      input.disabled = true;

      // Add user message to chat
      addMessage('You', query, 'user');
      input.value = '';

      // Show typing indicator
      showTyping();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            query: query,
            session_id: sessionId
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          sessionId = data.session_id;
          
          // Add bot/agent response
          const senderType = data.status === 'with_agent' ? 'agent' : 'bot';
          const senderName = data.status === 'with_agent' ? 'Agent' : 'AI Assistant';
          addMessage(senderName, data.answer, senderType);
          
          // Update message count (user message + bot response = +2)
          lastMessageCount += 2;
          
          // Update chat status
          updateChatStatus(data.status, data);
          updateConnectionStatus(true);
          
          // Start polling if status changed to waiting or with agent
          if (data.status === 'waiting_agent' || data.status === 'with_agent') {
            startPolling();
          }
        } else {
          addMessage('System', 'Sorry, there was an error. Please try again.', 'system');
          updateConnectionStatus(false);
        }
      } catch (error) {
        console.error('Error:', error);
        addMessage('System', 'Connection error. Please check your internet connection.', 'system');
        updateConnectionStatus(false);
      } finally {
        hideTyping();
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    function addMessage(sender, content, type) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type === 'user' ? 'user' : ''}`;

      const avatarClass = {
        'user': 'avatar-user',
        'bot': 'avatar-bot',
        'agent': 'avatar-agent',
        'system': 'avatar-system'
      }[type] || 'avatar-bot';

      const avatarIcon = {
        'user': 'üë§',
        'bot': 'ü§ñ',
        'agent': 'üë®‚Äçüíº',
        'system': '‚ö†Ô∏è'
      }[type] || 'ü§ñ';

      const contentClass = type === 'user' ? '' : type;
      const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      messageDiv.innerHTML = `
        <div class="message-avatar ${avatarClass}">${avatarIcon}</div>
        <div class="message-content ${contentClass}">
          <div class="message-sender">${sender}</div>
          <div>${content}</div>
          <div class="message-time">${timestamp}</div>
        </div>
      `;

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping(text = 'AI is thinking...') {
      const typingIndicator = document.getElementById('typingIndicator');
      const typingText = document.getElementById('typingText');
      typingText.textContent = text;
      typingIndicator.style.display = 'block';
    }

    function hideTyping() {
      document.getElementById('typingIndicator').style.display = 'none';
    }

    async function requestAgent() {
      const input = document.getElementById('userQuery');
      input.value = 'I would like to talk to a human agent please';
      await sendQuery();
    }

    async function endChat() {
      if (confirm('Are you sure you want to end this chat session?')) {
        // Add system message
        addMessage('System', 'Chat session ended. Thank you for contacting us!', 'system');
        updateChatStatus('ended');
        
        // Reset session
        sessionId = null;
        stopPolling();
      }
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear the chat history?')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
          <div class="message">
            <div class="message-avatar avatar-bot">ü§ñ</div>
            <div class="message-content bot">
              <div class="message-sender">AI Assistant</div>
              <div>üí° Hello! I'm here to help you. How can I assist you today?</div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        `;
        
        sessionId = null;
        updateChatStatus('bot');
        stopPolling();
      }
    }

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      
      pollInterval = setInterval(async () => {
        if (!sessionId || (chatStatus !== 'waiting_agent' && chatStatus !== 'with_agent')) {
          return;
        }

        try {
          const response = await fetch(`/session/messages/${sessionId}`);
          if (response.ok) {
            const data = await response.json();
            
            // Check if there are new messages
            if (data.messages && data.messages.length > lastMessageCount) {
              // Display new messages
              for (let i = lastMessageCount; i < data.messages.length; i++) {
                const message = data.messages[i];
                
                // Skip user messages as they're already displayed
                if (message.sender_type === 'user') continue;
                
                // Display agent/bot/system messages
                const senderName = message.sender_type === 'agent' ? message.sender : 
                                 message.sender_type === 'bot' ? 'AI Assistant' : 'System';
                addMessage(senderName, message.content, message.sender_type);
              }
              lastMessageCount = data.messages.length;
            }
            
            // Update chat status if changed
            if (data.status !== chatStatus) {
              updateChatStatus(data.status, { agent_name: getAgentNameFromMessages(data.messages) });
            }
            
            updateConnectionStatus(true);
          }
        } catch (error) {
          console.error('Polling error:', error);
          updateConnectionStatus(false);
        }
      }, 2000); // Poll every 2 seconds for better responsiveness
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }
    
    function getAgentNameFromMessages(messages) {
      // Find the latest agent message to get agent name
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].sender_type === 'agent') {
          return messages[i].sender;
        }
      }
      return 'Agent';
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      stopPolling();
    });
  </script>
</body>
</html>